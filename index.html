<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨Ø·Ø§Ù‚Ø§Øª ØªÙ‡Ù†Ø¦Ø© Ø±Ù…Ø¶Ø§Ù†</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700;800&family=Reem+Kufi:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #D4A548;
    --gold-light: #F0D78C;
    --gold-dark: #B8860B;
    --deep-navy: #0A1628;
    --navy: #0F2042;
    --navy-light: #1A3060;
    --cream: #FFF8E7;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Tajawal', sans-serif; background: var(--deep-navy); min-height: 100vh; overflow-x: hidden; color: var(--cream); }

  .stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; overflow: hidden; }
  .star { position: absolute; width: 2px; height: 2px; background: var(--gold-light); border-radius: 50%; animation: twinkle var(--dur) ease-in-out infinite; opacity: 0; }
  @keyframes twinkle { 0%, 100% { opacity: 0.1; transform: scale(0.8); } 50% { opacity: 0.9; transform: scale(1.2); } }

  .header { position: relative; z-index: 2; text-align: center; padding: 50px 20px 30px; }
  .header-crescent { font-size: 60px; margin-bottom: 10px; animation: float 4s ease-in-out infinite; filter: drop-shadow(0 0 20px rgba(212,165,72,0.5)); }
  @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
  .header h1 { font-family: 'Reem Kufi', sans-serif; font-size: clamp(2rem,5vw,3.5rem); font-weight: 700; background: linear-gradient(135deg, var(--gold-light), var(--gold), var(--gold-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 8px; }
  .header p { font-family: 'Amiri', serif; font-size: 1.15rem; color: rgba(255,248,231,0.6); }

  .builder-section { position: relative; z-index: 2; max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; align-items: start; }
  @media (max-width: 900px) { .builder-section { grid-template-columns: 1fr; } }

  .controls-panel { background: rgba(15,32,66,0.7); backdrop-filter: blur(20px); border: 1px solid rgba(212,165,72,0.2); border-radius: 20px; padding: 30px; }
  .controls-panel h2 { font-family: 'Reem Kufi', sans-serif; color: var(--gold); font-size: 1.4rem; margin-bottom: 24px; display: flex; align-items: center; gap: 10px; }
  .control-group { margin-bottom: 22px; }
  .control-group label { display: block; font-size: 0.95rem; font-weight: 500; color: var(--gold-light); margin-bottom: 10px; }
  .control-group input[type="text"], .control-group textarea { width: 100%; padding: 12px 16px; background: rgba(10,22,40,0.8); border: 1px solid rgba(212,165,72,0.25); border-radius: 12px; color: var(--cream); font-family: 'Tajawal', sans-serif; font-size: 1rem; outline: none; transition: border-color 0.3s; direction: rtl; }
  .control-group input:focus, .control-group textarea:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(212,165,72,0.15); }
  .control-group textarea { resize: vertical; min-height: 80px; }

  .templates-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .template-btn { position: relative; padding: 14px 8px; border: 2px solid rgba(212,165,72,0.2); border-radius: 12px; background: rgba(10,22,40,0.6); color: var(--cream); cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 0.8rem; font-weight: 500; transition: all 0.3s ease; text-align: center; }
  .template-btn .template-icon { font-size: 1.6rem; display: block; margin-bottom: 4px; }
  .template-btn:hover { border-color: var(--gold); background: rgba(212,165,72,0.1); transform: translateY(-2px); }
  .template-btn.active { border-color: var(--gold); background: rgba(212,165,72,0.15); box-shadow: 0 0 20px rgba(212,165,72,0.2); }
  .template-btn.active::after { content: 'âœ“'; position: absolute; top: 4px; left: 4px; width: 18px; height: 18px; background: var(--gold); color: var(--deep-navy); border-radius: 50%; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; font-weight: 700; }

  /* Upload Button */
  .upload-btn { position: relative; padding: 14px 8px; border: 2px dashed rgba(212,165,72,0.35); border-radius: 12px; background: rgba(212,165,72,0.05); color: var(--gold-light); cursor: pointer; font-family: 'Tajawal', sans-serif; font-size: 0.8rem; font-weight: 500; transition: all 0.3s ease; text-align: center; overflow: hidden; }
  .upload-btn .template-icon { font-size: 1.6rem; display: block; margin-bottom: 4px; }
  .upload-btn:hover { border-color: var(--gold); background: rgba(212,165,72,0.12); transform: translateY(-2px); }
  .upload-btn.has-image { border-style: solid; border-color: var(--gold); background: rgba(212,165,72,0.15); box-shadow: 0 0 20px rgba(212,165,72,0.2); }
  .upload-btn.has-image::after { content: 'âœ“'; position: absolute; top: 4px; left: 4px; width: 18px; height: 18px; background: var(--gold); color: var(--deep-navy); border-radius: 50%; font-size: 0.65rem; display: flex; align-items: center; justify-content: center; font-weight: 700; }
  .upload-btn input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .upload-thumb { width: 32px; height: 32px; border-radius: 6px; object-fit: cover; margin: 0 auto 4px; display: none; border: 1px solid var(--gold); }
  .upload-btn.has-image .upload-thumb { display: block; }
  .upload-btn.has-image .template-icon { display: none; }

  /* Image Controls */
  .image-controls { display: none; margin-top: 14px; padding: 16px; background: rgba(10,22,40,0.6); border: 1px solid rgba(212,165,72,0.15); border-radius: 14px; animation: fadeSlideIn 0.3s ease; }
  .image-controls.visible { display: block; }
  @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
  .image-controls-title { font-size: 0.9rem; color: var(--gold); font-weight: 600; margin-bottom: 14px; display: flex; align-items: center; gap: 6px; }
  .slider-group { margin-bottom: 14px; }
  .slider-group:last-child { margin-bottom: 0; }
  .slider-label { display: flex; justify-content: space-between; align-items: center; font-size: 0.82rem; color: rgba(255,248,231,0.7); margin-bottom: 6px; }
  .slider-value { font-size: 0.75rem; color: var(--gold); font-weight: 600; background: rgba(212,165,72,0.1); padding: 2px 8px; border-radius: 6px; }
  input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px; background: rgba(212,165,72,0.15); outline: none; cursor: pointer; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--gold); cursor: pointer; box-shadow: 0 2px 8px rgba(212,165,72,0.4); }
  input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: var(--gold); cursor: pointer; border: none; }
  .overlay-color-row { display: flex; gap: 8px; margin-top: 10px; }
  .overlay-color-btn { width: 28px; height: 28px; border-radius: 8px; border: 2px solid rgba(212,165,72,0.2); cursor: pointer; transition: all 0.2s; }
  .overlay-color-btn:hover { transform: scale(1.1); border-color: var(--gold); }
  .overlay-color-btn.active { border-color: var(--gold); box-shadow: 0 0 10px rgba(212,165,72,0.3); transform: scale(1.1); }
  .position-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; width: 80px; margin: 8px auto 0; }
  .pos-btn { width: 24px; height: 24px; border: 1px solid rgba(212,165,72,0.2); border-radius: 4px; background: rgba(10,22,40,0.6); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; color: rgba(255,248,231,0.4); }
  .pos-btn:hover, .pos-btn.active { border-color: var(--gold); background: rgba(212,165,72,0.2); color: var(--gold); }
  .image-remove-btn { width: 100%; margin-top: 14px; padding: 10px; background: rgba(220,53,69,0.15); border: 1px solid rgba(220,53,69,0.3); border-radius: 10px; color: #ff6b7a; font-family: 'Tajawal', sans-serif; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .image-remove-btn:hover { background: rgba(220,53,69,0.25); border-color: rgba(220,53,69,0.5); }

  .actions-row { display: flex; gap: 12px; margin-top: 24px; }
  .btn-primary, .btn-secondary { flex: 1; padding: 14px 20px; border: none; border-radius: 14px; font-family: 'Tajawal', sans-serif; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .btn-primary { background: linear-gradient(135deg, var(--gold), var(--gold-dark)); color: var(--deep-navy); box-shadow: 0 4px 20px rgba(212,165,72,0.3); }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(212,165,72,0.4); }
  .btn-secondary { background: rgba(212,165,72,0.1); border: 1px solid rgba(212,165,72,0.3); color: var(--gold); }
  .btn-secondary:hover { background: rgba(212,165,72,0.2); transform: translateY(-2px); }

  .preview-wrapper { position: sticky; top: 30px; }
  .preview-label { font-family: 'Reem Kufi', sans-serif; color: var(--gold); font-size: 1.2rem; margin-bottom: 16px; text-align: center; }
  .card-preview { width: 100%; aspect-ratio: 4/5; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(212,165,72,0.15); transition: transform 0.5s ease; }
  .card-preview:hover { transform: scale(1.02); }
  .card-canvas { width: 100%; height: 100%; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 30px; text-align: center; overflow: hidden; }

  .card-bg-image { position: absolute; inset: 0; background-size: cover; background-position: center center; background-repeat: no-repeat; z-index: 0; display: none; }
  .card-bg-image.active { display: block; }
  .card-bg-overlay { position: absolute; inset: 0; z-index: 1; display: none; }
  .card-bg-overlay.active { display: block; }

  .theme-classic { background: linear-gradient(180deg, #0A1628 0%, #0F2042 40%, #1A3060 100%); }
  .theme-emerald { background: linear-gradient(160deg, #0B3D2E 0%, #1B6B4A 50%, #0D4F4F 100%); }
  .theme-purple { background: linear-gradient(160deg, #1A0A2E 0%, #2D1B4E 50%, #1A0A2E 100%); }
  .theme-sunset { background: linear-gradient(160deg, #4A1A00 0%, #8B3A0F 40%, #C45A1A 100%); }
  .theme-white { background: linear-gradient(180deg, #FFFEF5 0%, #F5ECD7 50%, #EDE3C8 100%); }
  .theme-white .card-greeting, .theme-white .card-message, .theme-white .card-sender { color: #2A1F0A !important; }
  .theme-white .card-greeting, .theme-white .card-sender { background: linear-gradient(135deg, #B8860B, #8B6914) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; }
  .theme-teal { background: linear-gradient(160deg, #042F2E 0%, #0D4F4F 50%, #134E4A 100%); }
  .card-canvas.custom-image-active { background: #000 !important; }

  .card-decorations { position: absolute; inset: 0; pointer-events: none; overflow: hidden; z-index: 3; }
  .card-geometric { position: absolute; border: 1px solid rgba(212,165,72,0.15); border-radius: 50%; }
  .card-lantern { position: absolute; font-size: 2.5rem; opacity: 0.3; animation: sway 5s ease-in-out infinite; }
  @keyframes sway { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
  .card-content-wrapper { position: relative; z-index: 4; display: flex; flex-direction: column; align-items: center; }
  .card-crescent-deco { margin-bottom: 10px; filter: drop-shadow(0 0 25px rgba(212,165,72,0.6)); animation: glow-pulse 3s ease-in-out infinite; }
  .card-crescent-deco svg { width: 70px; height: 70px; }
  @keyframes glow-pulse { 0%, 100% { filter: drop-shadow(0 0 20px rgba(212,165,72,0.4)); } 50% { filter: drop-shadow(0 0 35px rgba(212,165,72,0.8)); } }
  .card-greeting { font-family: 'Reem Kufi', sans-serif; font-size: clamp(1.6rem,4vw,2.4rem); font-weight: 700; color: var(--gold-light); line-height: 1.5; margin-bottom: 16px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  .card-divider { width: 80px; height: 2px; background: linear-gradient(90deg, transparent, var(--gold), transparent); margin: 0 auto 16px; }
  .card-message { font-family: 'Amiri', serif; font-size: clamp(0.95rem,2vw,1.15rem); color: rgba(255,248,231,0.85); line-height: 1.9; max-width: 85%; margin: 0 auto 20px; }
  .card-sender { font-family: 'Reem Kufi', sans-serif; font-size: 1.1rem; color: var(--gold-light); font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  .card-border-frame { position: absolute; inset: 12px; border: 1px solid rgba(212,165,72,0.2); border-radius: 12px; pointer-events: none; z-index: 5; }
  .card-corner { position: absolute; width: 20px; height: 20px; border-color: var(--gold); border-style: solid; opacity: 0.5; z-index: 5; }
  .card-corner.tl { top: 8px; right: 8px; border-width: 2px 2px 0 0; border-radius: 0 6px 0 0; }
  .card-corner.tr { top: 8px; left: 8px; border-width: 2px 0 0 2px; border-radius: 6px 0 0 0; }
  .card-corner.bl { bottom: 8px; right: 8px; border-width: 0 2px 2px 0; border-radius: 0 0 6px 0; }
  .card-corner.br { bottom: 8px; left: 8px; border-width: 0 0 2px 2px; border-radius: 0 0 0 6px; }
  .islamic-pattern { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.04; background-image: repeating-conic-gradient(from 0deg at 50% 50%, transparent 0deg 60deg, rgba(212,165,72,0.5) 60deg 120deg); background-size: 60px 60px; pointer-events: none; z-index: 2; }
  .card-sparkle { position: absolute; width: 4px; height: 4px; background: var(--gold-light); border-radius: 50%; animation: sparkle-float var(--dur) ease-in-out infinite; opacity: 0; }
  @keyframes sparkle-float { 0%, 100% { opacity: 0; transform: translateY(0) scale(0.5); } 50% { opacity: 0.7; transform: translateY(-20px) scale(1); } }

  .gallery-section { position: relative; z-index: 2; max-width: 1200px; margin: 60px auto 40px; padding: 0 20px; }
  .gallery-section h2 { font-family: 'Reem Kufi', sans-serif; text-align: center; color: var(--gold); font-size: 1.8rem; margin-bottom: 30px; }
  .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
  .gallery-card { aspect-ratio: 4/5; border-radius: 16px; overflow: hidden; cursor: pointer; position: relative; transition: all 0.4s ease; box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
  .gallery-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 16px 50px rgba(212,165,72,0.2); }
  .gallery-card-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent 50%); display: flex; align-items: flex-end; justify-content: center; padding: 20px; opacity: 0; transition: opacity 0.3s; }
  .gallery-card:hover .gallery-card-overlay { opacity: 1; }
  .gallery-card-overlay span { background: var(--gold); color: var(--deep-navy); padding: 8px 20px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }

  .footer { position: relative; z-index: 2; text-align: center; padding: 40px 20px; color: rgba(255,248,231,0.3); font-size: 0.85rem; font-family: 'Amiri', serif; }
  .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--gold); color: var(--deep-navy); padding: 14px 28px; border-radius: 14px; font-weight: 700; font-size: 0.95rem; z-index: 200; transition: transform 0.4s ease; box-shadow: 0 8px 30px rgba(212,165,72,0.4); }
  .toast.show { transform: translateX(-50%) translateY(0); }
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--deep-navy); }
  ::-webkit-scrollbar-thumb { background: rgba(212,165,72,0.3); border-radius: 4px; }
</style>
</head>
<body>

<div class="stars-container" id="starsContainer"></div>

<header class="header">
  <div class="header-crescent"><svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 5 C28 5 10 23 10 50 C10 77 28 95 50 95 C35 85 28 68 28 50 C28 32 35 15 50 5Z" fill="#F0D78C"/><polygon points="68,32 70,38 76,38 71,42 73,48 68,44 63,48 65,42 60,38 66,38" fill="#F0D78C"/></svg></div>
  <h1>Ø¨Ø·Ø§Ù‚Ø§Øª ØªÙ‡Ù†Ø¦Ø© Ø±Ù…Ø¶Ø§Ù†</h1>
  <p>ØµÙ…Ù‘Ù… Ø¨Ø·Ø§Ù‚ØªÙƒ Ø§Ù„Ø®Ø§ØµØ© ÙˆØ´Ø§Ø±ÙƒÙ‡Ø§ Ù…Ø¹ Ø£Ø­Ø¨Ø§Ø¦Ùƒ</p>
</header>

<section class="builder-section">
  <div class="controls-panel">
    <h2>âœ¨ ØªØ®ØµÙŠØµ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h2>

    <div class="control-group">
      <label>ğŸ¨ Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±ØªÙƒ</label>
      <div class="templates-grid">
        <button class="template-btn active" data-theme="classic" onclick="selectTheme('classic', this)"><span class="template-icon">ğŸŒ™</span>ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ</button>
        <button class="template-btn" data-theme="emerald" onclick="selectTheme('emerald', this)"><span class="template-icon">ğŸŒ¿</span>Ø²Ù…Ø±Ø¯ÙŠ</button>
        <button class="template-btn" data-theme="purple" onclick="selectTheme('purple', this)"><span class="template-icon">ğŸ‘‘</span>Ù…Ù„ÙƒÙŠ</button>
        <button class="template-btn" data-theme="sunset" onclick="selectTheme('sunset', this)"><span class="template-icon">ğŸŒ…</span>ØºØ±ÙˆØ¨</button>
        <button class="template-btn" data-theme="white" onclick="selectTheme('white', this)"><span class="template-icon">ğŸ•Šï¸</span>Ø£Ù†ÙŠÙ‚</button>
        <button class="template-btn" data-theme="teal" onclick="selectTheme('teal', this)"><span class="template-icon">ğŸ’</span>ÙÙŠØ±ÙˆØ²ÙŠ</button>
        <label class="upload-btn" id="uploadBtn">
          <img class="upload-thumb" id="uploadThumb" src="" alt="">
          <span class="template-icon">ğŸ“·</span>
          Ø±ÙØ¹ ØµÙˆØ±Ø©
          <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">
        </label>
      </div>

      <div class="image-controls" id="imageControls">
        <div class="image-controls-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØ±Ø©</div>
        <div class="slider-group">
          <div class="slider-label"><span>ğŸ”² Ø´ÙØ§ÙÙŠØ© Ø§Ù„ØºØ·Ø§Ø¡</span><span class="slider-value" id="overlayVal">50%</span></div>
          <input type="range" id="overlayOpacity" min="0" max="100" value="50" oninput="updateImageSettings()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>ğŸ”† Ø³Ø·ÙˆØ¹ Ø§Ù„ØµÙˆØ±Ø©</span><span class="slider-value" id="brightnessVal">100%</span></div>
          <input type="range" id="imageBrightness" min="20" max="180" value="100" oninput="updateImageSettings()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>ğŸŒ«ï¸ Ø¶Ø¨Ø§Ø¨ÙŠØ© Ø§Ù„ØµÙˆØ±Ø©</span><span class="slider-value" id="blurVal">0px</span></div>
          <input type="range" id="imageBlur" min="0" max="20" value="0" oninput="updateImageSettings()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>ğŸ” Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©</span><span class="slider-value" id="scaleVal">100%</span></div>
          <input type="range" id="imageScale" min="100" max="250" value="100" oninput="updateImageSettings()">
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>ğŸ¨ Ù„ÙˆÙ† Ø§Ù„ØºØ·Ø§Ø¡</span></div>
          <div class="overlay-color-row">
            <button class="overlay-color-btn active" style="background:#0A1628;" data-color="10,22,40" onclick="selectOverlayColor(this)"></button>
            <button class="overlay-color-btn" style="background:#0B3D2E;" data-color="11,61,46" onclick="selectOverlayColor(this)"></button>
            <button class="overlay-color-btn" style="background:#1A0A2E;" data-color="26,10,46" onclick="selectOverlayColor(this)"></button>
            <button class="overlay-color-btn" style="background:#4A1A00;" data-color="74,26,0" onclick="selectOverlayColor(this)"></button>
            <button class="overlay-color-btn" style="background:#D4A548;" data-color="212,165,72" onclick="selectOverlayColor(this)"></button>
            <button class="overlay-color-btn" style="background:#000000;" data-color="0,0,0" onclick="selectOverlayColor(this)"></button>
          </div>
        </div>
        <div class="slider-group">
          <div class="slider-label"><span>ğŸ“Œ Ù…ÙˆØ¶Ø¹ Ø§Ù„ØµÙˆØ±Ø©</span></div>
          <div class="position-grid">
            <button class="pos-btn" data-pos="top left" onclick="selectPosition(this)">â†—</button>
            <button class="pos-btn" data-pos="top center" onclick="selectPosition(this)">â†‘</button>
            <button class="pos-btn" data-pos="top right" onclick="selectPosition(this)">â†–</button>
            <button class="pos-btn" data-pos="center left" onclick="selectPosition(this)">â†’</button>
            <button class="pos-btn active" data-pos="center center" onclick="selectPosition(this)">â—</button>
            <button class="pos-btn" data-pos="center right" onclick="selectPosition(this)">â†</button>
            <button class="pos-btn" data-pos="bottom left" onclick="selectPosition(this)">â†˜</button>
            <button class="pos-btn" data-pos="bottom center" onclick="selectPosition(this)">â†“</button>
            <button class="pos-btn" data-pos="bottom right" onclick="selectPosition(this)">â†™</button>
          </div>
        </div>
        <button class="image-remove-btn" onclick="removeCustomImage()">ğŸ—‘ï¸ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©</button>
      </div>
    </div>

    <div class="control-group">
      <label>ğŸ“ Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªÙ‡Ù†Ø¦Ø©</label>
      <input type="text" id="greetingInput" value="Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…" placeholder="Ø§ÙƒØªØ¨ Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªÙ‡Ù†Ø¦Ø©..." oninput="updateCard()">
    </div>
    <div class="control-group">
      <label>ğŸ’Œ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©</label>
      <textarea id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." oninput="updateCard()">Ø£Ø¹Ø§Ø¯Ù‡ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙƒÙ… Ø¨Ø§Ù„Ø®ÙŠØ± ÙˆØ§Ù„Ø¨Ø±ÙƒØ§ØªØŒ ÙˆØ¬Ø¹Ù„ Ø£ÙŠØ§Ù…ÙƒÙ… ÙƒÙ„Ù‡Ø§ Ø³Ø¹Ø§Ø¯Ø© ÙˆØ·Ø§Ø¹Ø©</textarea>
    </div>
    <div class="control-group">
      <label>âœï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø³Ù„</label>
      <input type="text" id="senderInput" placeholder="Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." oninput="updateCard()">
    </div>
    <div class="actions-row">
      <button class="btn-primary" onclick="downloadCard()">ğŸ“¥ ØµÙˆØ±Ø©</button>
      <button class="btn-primary" style="background:linear-gradient(135deg,#D4A548,#8B3A0F);" onclick="downloadGif()">ğŸ¬ GIF Ù…ØªØ­Ø±Ùƒ</button>
      <button class="btn-secondary" onclick="copyCard()">ğŸ“‹ Ù†Ø³Ø®</button>
    </div>
    <div id="gifProgress" style="display:none;margin-top:12px;text-align:center;">
      <div style="background:rgba(10,22,40,0.8);border:1px solid rgba(212,165,72,0.25);border-radius:12px;padding:14px;overflow:hidden;position:relative;">
        <div id="gifProgressBar" style="position:absolute;top:0;left:0;height:100%;width:0%;background:rgba(212,165,72,0.15);border-radius:12px;transition:width 0.3s;"></div>
        <span id="gifProgressText" style="position:relative;color:var(--gold-light);font-size:0.9rem;font-weight:600;">â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ GIF...</span>
      </div>
    </div>
  </div>

  <div class="preview-wrapper">
    <div class="preview-label">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</div>
    <div class="card-preview" id="cardPreview">
      <div class="card-canvas theme-classic" id="cardCanvas">
        <div class="card-bg-image" id="cardBgImage"></div>
        <div class="card-bg-overlay" id="cardBgOverlay"></div>
        <div class="islamic-pattern"></div>
        <div class="card-decorations" id="cardDecorations"></div>
        <div class="card-border-frame"></div>
        <div class="card-corner tl"></div>
        <div class="card-corner tr"></div>
        <div class="card-corner bl"></div>
        <div class="card-corner br"></div>
        <div class="card-content-wrapper">
          <div class="card-crescent-deco" id="cardCrescent"><svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="moonGlow" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="#F0D78C"/><stop offset="100%" stop-color="#D4A548"/></radialGradient></defs><path d="M50 5 C28 5 10 23 10 50 C10 77 28 95 50 95 C35 85 28 68 28 50 C28 32 35 15 50 5Z" fill="url(#moonGlow)"/><polygon points="68,32 70,38 76,38 71,42 73,48 68,44 63,48 65,42 60,38 66,38" fill="#F0D78C"/></svg></div>
          <div class="card-greeting" id="cardGreeting">Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…</div>
          <div class="card-divider"></div>
          <div class="card-message" id="cardMessage">Ø£Ø¹Ø§Ø¯Ù‡ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙƒÙ… Ø¨Ø§Ù„Ø®ÙŠØ± ÙˆØ§Ù„Ø¨Ø±ÙƒØ§ØªØŒ ÙˆØ¬Ø¹Ù„ Ø£ÙŠØ§Ù…ÙƒÙ… ÙƒÙ„Ù‡Ø§ Ø³Ø¹Ø§Ø¯Ø© ÙˆØ·Ø§Ø¹Ø©</div>
          <div class="card-sender" id="cardSender"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="gallery-section">
  <h2>ğŸ® Ø¨Ø·Ø§Ù‚Ø§Øª Ø¬Ø§Ù‡Ø²Ø©</h2>
  <div class="gallery-grid" id="galleryGrid"></div>
</section>

<footer class="footer"><p>Ø±Ù…Ø¶Ø§Ù† Ù…Ø¨Ø§Ø±Ùƒ ğŸŒ™ ØªÙ‚Ø¨Ù‘Ù„ Ø§Ù„Ù„Ù‡ Ù…Ù†Ù‘Ø§ ÙˆÙ…Ù†ÙƒÙ… ØµØ§Ù„Ø­ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„</p></footer>
<div class="toast" id="toast"></div>

<script>
let currentTheme = 'classic';
let customImageData = null;
let customImageActive = false;
let overlayColor = '10,22,40';
let imagePosition = 'center center';

// Stars
const sc = document.getElementById('starsContainer');
for (let i = 0; i < 100; i++) {
  const s = document.createElement('div');
  s.className = 'star';
  s.style.left = Math.random()*100+'%';
  s.style.top = Math.random()*100+'%';
  s.style.setProperty('--dur', (2+Math.random()*4)+'s');
  s.style.animationDelay = Math.random()*4+'s';
  s.style.width = s.style.height = (1+Math.random()*2)+'px';
  sc.appendChild(s);
}

// Card Decorations
function createCardDecorations() {
  const d = document.getElementById('cardDecorations');
  d.innerHTML = '';
  [{top:'5%',right:'8%',size:'2rem',delay:'0s'},{top:'8%',left:'10%',size:'1.8rem',delay:'1s'},{top:'15%',right:'20%',size:'1.4rem',delay:'0.5s'}].forEach(p => {
    const l = document.createElement('div');
    l.className = 'card-lantern'; l.textContent = 'ğŸ®';
    l.style.top = p.top;
    if(p.right) l.style.right = p.right;
    if(p.left) l.style.left = p.left;
    l.style.fontSize = p.size; l.style.animationDelay = p.delay;
    d.appendChild(l);
  });
  for(let i=0;i<12;i++){
    const sp = document.createElement('div');
    sp.className = 'card-sparkle';
    sp.style.left = (10+Math.random()*80)+'%';
    sp.style.top = (10+Math.random()*80)+'%';
    sp.style.setProperty('--dur', (3+Math.random()*4)+'s');
    sp.style.animationDelay = Math.random()*5+'s';
    d.appendChild(sp);
  }
  for(let i=0;i<3;i++){
    const g = document.createElement('div');
    g.className = 'card-geometric';
    const sz = 100+Math.random()*200;
    g.style.width = g.style.height = sz+'px';
    g.style.left = (-30+Math.random()*60)+'%';
    g.style.top = (20+Math.random()*60)+'%';
    d.appendChild(g);
  }
}
createCardDecorations();

function selectTheme(theme, btn) {
  currentTheme = theme;
  customImageActive = false;
  document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('uploadBtn').classList.remove('has-image');
  btn.classList.add('active');
  const canvas = document.getElementById('cardCanvas');
  canvas.className = 'card-canvas theme-' + theme;
  document.getElementById('cardBgImage').classList.remove('active');
  document.getElementById('cardBgOverlay').classList.remove('active');
  document.getElementById('imageControls').classList.remove('visible');
  document.getElementById('cardCrescent').style.display = 'block';
  createCardDecorations();
}

function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (!file.type.startsWith('image/')) { showToast('âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø©'); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    customImageData = e.target.result;
    customImageActive = true;
    const ub = document.getElementById('uploadBtn');
    ub.classList.add('has-image');
    document.getElementById('uploadThumb').src = customImageData;
    document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('cardCanvas').className = 'card-canvas custom-image-active';
    const bg = document.getElementById('cardBgImage');
    bg.style.backgroundImage = 'url('+customImageData+')';
    bg.classList.add('active');
    document.getElementById('cardBgOverlay').classList.add('active');
    document.getElementById('imageControls').classList.add('visible');
    document.getElementById('cardCrescent').style.display = 'none';
    updateImageSettings();
    createCardDecorations();
    showToast('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!');
  };
  reader.readAsDataURL(file);
}

function updateImageSettings() {
  const op = document.getElementById('overlayOpacity').value;
  const br = document.getElementById('imageBrightness').value;
  const bl = document.getElementById('imageBlur').value;
  const sc = document.getElementById('imageScale').value;
  document.getElementById('overlayVal').textContent = op+'%';
  document.getElementById('brightnessVal').textContent = br+'%';
  document.getElementById('blurVal').textContent = bl+'px';
  document.getElementById('scaleVal').textContent = sc+'%';
  const bg = document.getElementById('cardBgImage');
  bg.style.filter = 'brightness('+(br/100)+') blur('+bl+'px)';
  bg.style.backgroundSize = sc > 100 ? sc+'%' : 'cover';
  bg.style.backgroundPosition = imagePosition;
  document.getElementById('cardBgOverlay').style.background = 'rgba('+overlayColor+','+(op/100)+')';
}

function selectOverlayColor(btn) {
  document.querySelectorAll('.overlay-color-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  overlayColor = btn.dataset.color;
  updateImageSettings();
}

function selectPosition(btn) {
  document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  imagePosition = btn.dataset.pos;
  updateImageSettings();
}

function removeCustomImage() {
  customImageData = null; customImageActive = false;
  document.getElementById('cardBgImage').classList.remove('active');
  document.getElementById('cardBgImage').style.backgroundImage = '';
  document.getElementById('cardBgOverlay').classList.remove('active');
  document.getElementById('imageControls').classList.remove('visible');
  document.getElementById('uploadBtn').classList.remove('has-image');
  document.getElementById('uploadThumb').src = '';
  document.getElementById('imageUpload').value = '';
  selectTheme('classic', document.querySelector('[data-theme="classic"]'));
  showToast('ğŸ—‘ï¸ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©');
}

function updateCard() {
  document.getElementById('cardGreeting').textContent = document.getElementById('greetingInput').value || 'Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…';
  document.getElementById('cardMessage').textContent = document.getElementById('messageInput').value || '';
  const s = document.getElementById('senderInput').value;
  document.getElementById('cardSender').textContent = s ? ''+s : '';
}

async function downloadCard() {
  showToast('â³ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...');
  try {
    const card = document.getElementById('cardPreview');
    const canvas = document.createElement('canvas');
    const rect = card.getBoundingClientRect();
    const sc = 2;
    canvas.width = rect.width*sc; canvas.height = rect.height*sc;
    const ctx = canvas.getContext('2d');
    ctx.scale(sc, sc);

    if (customImageActive && customImageData) {
      await new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = function() {
          ctx.fillStyle = '#000'; ctx.fillRect(0,0,rect.width,rect.height);
          const br = document.getElementById('imageBrightness').value/100;
          const bl = document.getElementById('imageBlur').value;
          const scv = document.getElementById('imageScale').value/100;
          const op = document.getElementById('overlayOpacity').value/100;
          ctx.filter = 'brightness('+br+') blur('+bl+'px)';
          const ir = img.width/img.height, cr = rect.width/rect.height;
          let dw, dh;
          if(ir > cr) { dh = rect.height*scv; dw = dh*ir; } else { dw = rect.width*scv; dh = dw/ir; }
          const pm = {top:0,center:0.5,bottom:1,left:0,right:1};
          const [py,px] = imagePosition.split(' ');
          const dx = (rect.width-dw)*(pm[px]||0.5), dy = (rect.height-dh)*(pm[py]||0.5);
          ctx.drawImage(img,dx,dy,dw,dh);
          ctx.filter = 'none';
          ctx.fillStyle = 'rgba('+overlayColor+','+op+')';
          ctx.fillRect(0,0,rect.width,rect.height);
          resolve();
        };
        img.onerror = reject;
        img.src = customImageData;
      });
    } else {
      const tc = {classic:['#0A1628','#0F2042','#1A3060'],emerald:['#0B3D2E','#1B6B4A','#0D4F4F'],purple:['#1A0A2E','#2D1B4E','#1A0A2E'],sunset:['#4A1A00','#8B3A0F','#C45A1A'],white:['#FFFEF5','#F5ECD7','#EDE3C8'],teal:['#042F2E','#0D4F4F','#134E4A']};
      const c = tc[currentTheme];
      const g = ctx.createLinearGradient(0,0,0,rect.height);
      g.addColorStop(0,c[0]); g.addColorStop(0.5,c[1]); g.addColorStop(1,c[2]);
      ctx.fillStyle = g; ctx.fillRect(0,0,rect.width,rect.height);
    }

    // Border
    ctx.strokeStyle = 'rgba(212,165,72,0.2)'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.roundRect(12,12,rect.width-24,rect.height-24,12); ctx.stroke();

    // Corners
    ctx.strokeStyle = 'rgba(212,165,72,0.5)'; ctx.lineWidth = 2;
    const cs = 20;
    [[rect.width-8,10,rect.width-8,10+cs],[rect.width-10,8,rect.width-10-cs,8],
     [8,10,8,10+cs],[10,8,10+cs,8],
     [rect.width-8,rect.height-10,rect.width-8,rect.height-10-cs],[rect.width-10,rect.height-8,rect.width-10-cs,rect.height-8],
     [8,rect.height-10,8,rect.height-10-cs],[10,rect.height-8,10+cs,rect.height-8]
    ].forEach(([x1,y1,x2,y2]) => { ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); });

    const isW = currentTheme==='white' && !customImageActive;
    const txC = isW?'#2A1F0A':'#FFF8E7', gC = isW?'#B8860B':'#F0D78C';
    const cx = rect.width/2;
    let y = rect.height*0.28;

    ctx.textAlign = 'center';

    if (!customImageActive) {
      // Draw crescent moon
      ctx.save();
      const moonX = cx - 15, moonY = y - 20, moonR = 22;
      ctx.beginPath();
      ctx.arc(moonX, moonY, moonR, 0, Math.PI * 2);
      ctx.closePath();
      const moonGrad = ctx.createRadialGradient(moonX, moonY, 0, moonX, moonY, moonR);
      moonGrad.addColorStop(0, '#F0D78C');
      moonGrad.addColorStop(1, '#D4A548');
      ctx.fillStyle = moonGrad;
      ctx.fill();
      // Cut out inner circle for crescent
      ctx.globalCompositeOperation = 'destination-out';
      ctx.beginPath();
      ctx.arc(moonX + 12, moonY - 5, moonR - 4, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalCompositeOperation = 'source-over';
      // Star
      const starX = cx + 12, starY = y - 22;
      ctx.fillStyle = '#F0D78C';
      ctx.beginPath();
      for (let i = 0; i < 5; i++) {
        const angle = (i * 4 * Math.PI / 5) - Math.PI / 2;
        const r = i === 0 ? 0 : 7;
        if (i === 0) ctx.moveTo(starX + 7 * Math.cos(-Math.PI/2), starY + 7 * Math.sin(-Math.PI/2));
        else {
          const outerAngle = ((i) * 2 * Math.PI / 5) - Math.PI / 2;
          const innerAngle = ((i) * 2 * Math.PI / 5) - Math.PI / 2 + Math.PI / 5;
          ctx.lineTo(starX + 7 * Math.cos(outerAngle), starY + 7 * Math.sin(outerAngle));
          ctx.lineTo(starX + 3 * Math.cos(innerAngle), starY + 3 * Math.sin(innerAngle));
        }
      }
      ctx.closePath();
      ctx.fill();
      // Simpler star redraw
      ctx.fillStyle = '#F0D78C';
      function drawStar(cx2, cy2, outerR, innerR, points) {
        ctx.beginPath();
        for (let i = 0; i < points * 2; i++) {
          const r2 = i % 2 === 0 ? outerR : innerR;
          const a = (i * Math.PI / points) - Math.PI / 2;
          if (i === 0) ctx.moveTo(cx2 + r2 * Math.cos(a), cy2 + r2 * Math.sin(a));
          else ctx.lineTo(cx2 + r2 * Math.cos(a), cy2 + r2 * Math.sin(a));
        }
        ctx.closePath();
        ctx.fill();
      }
      drawStar(starX, starY, 7, 3, 5);
      ctx.restore();
      y += 30;
    }

    const greeting = document.getElementById('greetingInput').value || 'Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…';
    ctx.font = "bold 32px 'Reem Kufi','Tajawal',sans-serif"; ctx.fillStyle = gC;
    ctx.shadowColor = 'rgba(0,0,0,0.4)'; ctx.shadowBlur = 10;
    ctx.fillText(greeting, cx, y); ctx.shadowBlur = 0; y += 30;

    const dg = ctx.createLinearGradient(cx-40,y,cx+40,y);
    dg.addColorStop(0,'transparent'); dg.addColorStop(0.5,gC); dg.addColorStop(1,'transparent');
    ctx.strokeStyle = dg; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(cx-40,y); ctx.lineTo(cx+40,y); ctx.stroke(); y += 30;

    const msg = document.getElementById('messageInput').value;
    if (msg) {
      ctx.font = "18px 'Amiri','Tajawal',serif";
      ctx.fillStyle = isW?'rgba(42,31,10,0.85)':'rgba(255,248,231,0.85)';
      ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 5;
      const mw = rect.width*0.75; let line = '';
      for (const w of msg.split(' ')) {
        const tl = line+w+' ';
        if(ctx.measureText(tl).width>mw && line) { ctx.fillText(line.trim(),cx,y); line=w+' '; y+=28; } else line=tl;
      }
      ctx.fillText(line.trim(),cx,y); ctx.shadowBlur=0; y+=35;
    }

    const snd = document.getElementById('senderInput').value;
    if(snd) { ctx.font="bold 20px 'Reem Kufi','Tajawal',sans-serif"; ctx.fillStyle=gC; ctx.shadowColor='rgba(0,0,0,0.3)'; ctx.shadowBlur=10; ctx.fillText(''+snd,cx,y); ctx.shadowBlur=0; }

    canvas.toBlob(blob => {
      const u=URL.createObjectURL(blob), a=document.createElement('a');
      a.href=u; a.download='ramadan-card.png'; a.click(); URL.revokeObjectURL(u);
      showToast('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!');
    },'image/png');
  } catch(e) { showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„'); console.error(e); }
}

function copyCard() {
  const g=document.getElementById('greetingInput').value||'Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…';
  const m=document.getElementById('messageInput').value;
  const s=document.getElementById('senderInput').value;
  let t='ğŸŒ™ '+g+' ğŸŒ™\n\n'; if(m) t+=m+'\n\n'; if(s) t+=''+s;
  navigator.clipboard.writeText(t).then(()=>showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­!')).catch(()=>showToast('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®'));
}

function showToast(msg) {
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// Ready-Made Cards
const rc = [
  {theme:'classic',greeting:'Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…',message:'ÙƒÙ„ Ø¹Ø§Ù… ÙˆØ£Ù†ØªÙ… Ø¨Ø®ÙŠØ± Ø¨Ù…Ù†Ø§Ø³Ø¨Ø© Ø­Ù„ÙˆÙ„ Ø´Ù‡Ø± Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ'},
  {theme:'emerald',greeting:'Ø±Ù…Ø¶Ø§Ù† Ù…Ø¨Ø§Ø±Ùƒ',message:'Ø£Ø³Ø£Ù„ Ø§Ù„Ù„Ù‡ Ø£Ù† ÙŠØ¨Ù„ØºÙƒÙ… Ø±Ù…Ø¶Ø§Ù† ÙˆØ£Ù†ØªÙ… ÙÙŠ Ø£Ø­Ø³Ù† Ø­Ø§Ù„'},
  {theme:'purple',greeting:'Ù…Ø¨Ø§Ø±Ùƒ Ø¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø´Ù‡Ø±',message:'Ø¬Ø¹Ù„ Ø§Ù„Ù„Ù‡ Ø±Ù…Ø¶Ø§Ù† Ø´Ù‡Ø± Ø®ÙŠØ± ÙˆØ¨Ø±ÙƒØ© ÙˆØ¹ØªÙ‚ Ù…Ù† Ø§Ù„Ù†Ø§Ø±'},
  {theme:'sunset',greeting:'Ø£Ù‡Ù„Ø§Ù‹ Ø±Ù…Ø¶Ø§Ù†',message:'Ø§Ù„Ù„Ù‡Ù… Ø¨Ù„Ù‘ØºÙ†Ø§ Ø±Ù…Ø¶Ø§Ù† ÙˆØ§Ø±Ø²Ù‚Ù†Ø§ ØµÙŠØ§Ù…Ù‡ ÙˆÙ‚ÙŠØ§Ù…Ù‡ Ø¥ÙŠÙ…Ø§Ù†Ø§Ù‹ ÙˆØ§Ø­ØªØ³Ø§Ø¨Ø§Ù‹'},
  {theme:'white',greeting:'Ø´Ù‡Ø± Ø§Ù„Ø®ÙŠØ± ÙˆØ§Ù„Ø¨Ø±ÙƒØ§Øª',message:'Ù†Ø³Ø£Ù„ Ø§Ù„Ù„Ù‡ Ø£Ù† ÙŠØªÙ‚Ø¨Ù„ Ù…Ù†Ø§ ÙˆÙ…Ù†ÙƒÙ… Ø§Ù„ØµÙŠØ§Ù… ÙˆØ§Ù„Ù‚ÙŠØ§Ù… ÙˆØµØ§Ù„Ø­ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„'},
  {theme:'teal',greeting:'Ø±Ù…Ø¶Ø§Ù† ÙŠØ¬Ù…Ø¹Ù†Ø§',message:'Ø§Ù„Ù„Ù‡Ù… Ø§Ø¬Ø¹Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø´Ù‡Ø± Ø±Ø­Ù…Ø© ÙˆÙ…ØºÙØ±Ø© ÙˆØ¹ØªÙ‚ Ù…Ù† Ø§Ù„Ù†ÙŠØ±Ø§Ù†'},
];
const gg = document.getElementById('galleryGrid');
rc.forEach(card => {
  const tc = {classic:'linear-gradient(180deg,#0A1628,#0F2042,#1A3060)',emerald:'linear-gradient(160deg,#0B3D2E,#1B6B4A,#0D4F4F)',purple:'linear-gradient(160deg,#1A0A2E,#2D1B4E,#1A0A2E)',sunset:'linear-gradient(160deg,#4A1A00,#8B3A0F,#C45A1A)',white:'linear-gradient(180deg,#FFFEF5,#F5ECD7,#EDE3C8)',teal:'linear-gradient(160deg,#042F2E,#0D4F4F,#134E4A)'};
  const iw=card.theme==='white', gc=iw?'#B8860B':'#F0D78C', txc=iw?'#2A1F0A':'#FFF8E7';
  const el = document.createElement('div');
  el.className = 'gallery-card'; el.style.background = tc[card.theme];
  el.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:30px;text-align:center;position:relative;"><div style="position:absolute;inset:10px;border:1px solid rgba(212,165,72,0.15);border-radius:10px;pointer-events:none;"></div><div style="margin-bottom:8px;filter:drop-shadow(0 0 15px rgba(212,165,72,0.5));"><svg width="50" height="50" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M50 5 C28 5 10 23 10 50 C10 77 28 95 50 95 C35 85 28 68 28 50 C28 32 35 15 50 5Z" fill="'+gc+'"/><polygon points="68,32 70,38 76,38 71,42 73,48 68,44 63,48 65,42 60,38 66,38" fill="'+gc+'"/></svg></div><div style="font-family:Reem Kufi,sans-serif;font-size:1.5rem;font-weight:700;color:'+gc+';margin-bottom:12px;line-height:1.4;">'+card.greeting+'</div><div style="width:50px;height:1.5px;background:linear-gradient(90deg,transparent,'+gc+',transparent);margin:0 auto 12px;"></div><div style="font-family:Amiri,serif;font-size:0.9rem;color:'+txc+';opacity:0.8;line-height:1.8;max-width:90%;">'+card.message+'</div></div><div class="gallery-card-overlay"><span>Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ù„Ø¨</span></div>';
  el.addEventListener('click', () => {
    document.getElementById('greetingInput').value = card.greeting;
    document.getElementById('messageInput').value = card.message;
    selectTheme(card.theme, document.querySelector('[data-theme="'+card.theme+'"]'));
    updateCard();
    window.scrollTo({top:0,behavior:'smooth'});
    showToast('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ù„Ø¨!');
  });
  gg.appendChild(el);
});

// ===== Self-contained GIF Encoder =====
class GifEncoder {
  constructor(w, h) {
    this.width = w;
    this.height = h;
    this.frames = [];
    this.data = [];
  }

  addFrame(imageData, delay) {
    this.frames.push({ data: imageData, delay: Math.round(delay / 10) });
  }

  encode() {
    const d = this.data = [];
    const w = (v) => { d.push(v & 0xFF); };
    const w16 = (v) => { d.push(v & 0xFF); d.push((v >> 8) & 0xFF); };

    // Header
    [0x47,0x49,0x46,0x38,0x39,0x61].forEach(b => w(b)); // GIF89a

    // Logical Screen Descriptor
    w16(this.width); w16(this.height);
    w(0xF7); // GCT flag, 256 colors (2^(7+1))
    w(0); w(0); // bg color, pixel aspect

    // Global Color Table (256 RGB entries) - will use first frame's palette
    const palette = this._buildPalette(this.frames[0].data);
    palette.forEach(c => { w(c[0]); w(c[1]); w(c[2]); });

    // Netscape Extension (loop forever)
    w(0x21); w(0xFF); w(0x0B);
    [0x4E,0x45,0x54,0x53,0x43,0x41,0x50,0x45,0x32,0x2E,0x30].forEach(b => w(b));
    w(0x03); w(0x01); w16(0); w(0x00);

    // Frames
    for (const frame of this.frames) {
      const indexed = this._quantize(frame.data, palette);

      // Graphic Control Extension
      w(0x21); w(0xF9); w(0x04);
      w(0x08); // disposal: restore to bg
      w16(frame.delay);
      w(0x00); // transparent color index (none)
      w(0x00);

      // Image Descriptor
      w(0x2C);
      w16(0); w16(0); // left, top
      w16(this.width); w16(this.height);
      w(0x00); // no local color table

      // LZW compressed data
      this._writeLZW(indexed, 8);
    }

    w(0x3B); // Trailer
    return new Uint8Array(this.data);
  }

  _buildPalette(imgData) {
    // Sample colors and build a 256-color palette
    const colorMap = new Map();
    const pixels = imgData.data;
    const step = Math.max(1, Math.floor(pixels.length / 4 / 4000));

    for (let i = 0; i < pixels.length; i += step * 4) {
      // Reduce precision for grouping
      const r = pixels[i] & 0xF8;
      const g = pixels[i+1] & 0xF8;
      const h = pixels[i+2] & 0xF8;
      const key = (r << 16) | (g << 8) | h;
      colorMap.set(key, (colorMap.get(key) || 0) + 1);
    }

    // Sort by frequency, take top 256
    const sorted = [...colorMap.entries()].sort((a, b) => b[1] - a[1]).slice(0, 256);
    const palette = sorted.map(([key]) => [(key >> 16) & 0xFF, (key >> 8) & 0xFF, key & 0xFF]);

    // Pad to 256
    while (palette.length < 256) palette.push([0, 0, 0]);
    return palette;
  }

  _quantize(imgData, palette) {
    const pixels = imgData.data;
    const indexed = new Uint8Array(this.width * this.height);

    // Build lookup cache for speed
    const cache = new Map();

    for (let i = 0; i < indexed.length; i++) {
      const pi = i * 4;
      const r = pixels[pi], g = pixels[pi+1], b = pixels[pi+2];
      const cKey = ((r & 0xFC) << 16) | ((g & 0xFC) << 8) | (b & 0xFC);

      if (cache.has(cKey)) {
        indexed[i] = cache.get(cKey);
      } else {
        let best = 0, bestDist = Infinity;
        for (let j = 0; j < 256; j++) {
          const dr = r - palette[j][0], dg = g - palette[j][1], db = b - palette[j][2];
          const dist = dr*dr + dg*dg + db*db;
          if (dist < bestDist) { bestDist = dist; best = j; }
          if (dist === 0) break;
        }
        cache.set(cKey, best);
        indexed[i] = best;
      }
    }
    return indexed;
  }

  _writeLZW(indexed, minCodeSize) {
    const d = this.data;
    d.push(minCodeSize);

    const clearCode = 1 << minCodeSize;
    const eoiCode = clearCode + 1;

    let codeSize = minCodeSize + 1;
    let nextCode = eoiCode + 1;
    let maxCode = (1 << codeSize);

    let table = new Map();

    // Initialize table
    const resetTable = () => {
      table = new Map();
      for (let i = 0; i < clearCode; i++) table.set(String(i), i);
      codeSize = minCodeSize + 1;
      nextCode = eoiCode + 1;
      maxCode = (1 << codeSize);
    };

    resetTable();

    let buffer = 0;
    let bufBits = 0;
    let subBlock = [];
    let subBlockData = [];

    const writeCode = (code) => {
      buffer |= (code << bufBits);
      bufBits += codeSize;

      while (bufBits >= 8) {
        subBlock.push(buffer & 0xFF);
        buffer >>= 8;
        bufBits -= 8;

        if (subBlock.length >= 255) {
          subBlockData.push(subBlock.length);
          subBlock.forEach(b => subBlockData.push(b));
          subBlock = [];
        }
      }
    };

    writeCode(clearCode);

    if (indexed.length === 0) {
      writeCode(eoiCode);
    } else {
      let cur = String(indexed[0]);

      for (let i = 1; i < indexed.length; i++) {
        const k = String(indexed[i]);
        const combined = cur + ',' + k;

        if (table.has(combined)) {
          cur = combined;
        } else {
          writeCode(table.get(cur));

          if (nextCode < 4096) {
            table.set(combined, nextCode++);
            if (nextCode > maxCode && codeSize < 12) {
              codeSize++;
              maxCode = (1 << codeSize);
            }
          } else {
            writeCode(clearCode);
            resetTable();
          }
          cur = k;
        }
      }

      writeCode(table.get(cur));
      writeCode(eoiCode);
    }

    // Flush remaining bits
    if (bufBits > 0) {
      subBlock.push(buffer & 0xFF);
    }

    if (subBlock.length > 0) {
      subBlockData.push(subBlock.length);
      subBlock.forEach(b => subBlockData.push(b));
    }

    subBlockData.forEach(b => d.push(b));
    d.push(0x00); // Block terminator
  }
}

// ===== GIF Download =====
async function downloadGif() {
  const progress = document.getElementById('gifProgress');
  const progressBar = document.getElementById('gifProgressBar');
  const progressText = document.getElementById('gifProgressText');
  progress.style.display = 'block';
  progressBar.style.width = '0%';
  progressText.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ GIF...';
  showToast('â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ GIF Ø§Ù„Ù…ØªØ­Ø±Ùƒ...');

  try {
    const card = document.getElementById('cardPreview');
    const rect = card.getBoundingClientRect();
    const scale = 1; // full resolution for readability
    const W = Math.round(rect.width * scale);
    const H = Math.round(rect.height * scale);
    const totalFrames = 20;
    const frameDelay = 120;

    const encoder = new GifEncoder(W, H);

    const sparkles = [];
    for (let i = 0; i < 15; i++) {
      sparkles.push({ x: 0.1+Math.random()*0.8, y: 0.15+Math.random()*0.7, phase: Math.random()*Math.PI*2, speed: 0.8+Math.random()*1.2, size: 1.5+Math.random()*2.5 });
    }

    let customImg = null;
    if (customImageActive && customImageData) {
      customImg = await new Promise((res, rej) => { const img = new Image(); img.onload = () => res(img); img.onerror = rej; img.src = customImageData; });
    }

    const isW = currentTheme === 'white' && !customImageActive;
    const gC = isW ? '#B8860B' : '#F0D78C';
    const greeting = document.getElementById('greetingInput').value || 'Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…';
    const message = document.getElementById('messageInput').value;
    const sender = document.getElementById('senderInput').value;

    for (let frame = 0; frame < totalFrames; frame++) {
      const t = frame / totalFrames;
      const canvas = document.createElement('canvas');
      canvas.width = W; canvas.height = H;
      const ctx = canvas.getContext('2d');
      ctx.scale(scale, scale);
      const rW = rect.width, rH = rect.height;

      // Background
      if (customImg) {
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,rW,rH);
        const br = document.getElementById('imageBrightness').value/100;
        const bl = document.getElementById('imageBlur').value;
        const scv = document.getElementById('imageScale').value/100;
        const op = document.getElementById('overlayOpacity').value/100;
        ctx.filter = 'brightness('+br+')';
        const ir = customImg.width/customImg.height, cr = rW/rH;
        let dw, dh;
        if(ir > cr) { dh = rH*scv; dw = dh*ir; } else { dw = rW*scv; dh = dw/ir; }
        const pm = {top:0,center:0.5,bottom:1,left:0,right:1};
        const [py, px] = imagePosition.split(' ');
        const dx = (rW-dw)*(pm[px]||0.5), dy = (rH-dh)*(pm[py]||0.5);
        ctx.drawImage(customImg, dx, dy, dw, dh);
        ctx.filter = 'none';
        ctx.fillStyle = 'rgba('+overlayColor+','+op+')';
        ctx.fillRect(0,0,rW,rH);
      } else {
        const tc = {classic:['#0A1628','#0F2042','#1A3060'],emerald:['#0B3D2E','#1B6B4A','#0D4F4F'],purple:['#1A0A2E','#2D1B4E','#1A0A2E'],sunset:['#4A1A00','#8B3A0F','#C45A1A'],white:['#FFFEF5','#F5ECD7','#EDE3C8'],teal:['#042F2E','#0D4F4F','#134E4A']};
        const c = tc[currentTheme];
        const g = ctx.createLinearGradient(0,0,0,rH);
        g.addColorStop(0,c[0]); g.addColorStop(0.5,c[1]); g.addColorStop(1,c[2]);
        ctx.fillStyle = g; ctx.fillRect(0,0,rW,rH);
      }

      // Sparkles
      sparkles.forEach(sp => {
        const alpha = Math.max(0, Math.sin(sp.phase + t*Math.PI*2*sp.speed));
        if (alpha > 0.1) {
          ctx.save(); ctx.globalAlpha = alpha*0.8;
          ctx.fillStyle = gC; ctx.shadowColor = gC; ctx.shadowBlur = 8;
          ctx.beginPath(); ctx.arc(sp.x*rW, sp.y*rH - alpha*8, sp.size*alpha*2, 0, Math.PI*2); ctx.fill();
          ctx.restore();
        }
      });

      // Border & Corners
      ctx.strokeStyle = 'rgba(212,165,72,0.2)'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.roundRect(12,12,rW-24,rH-24,12); ctx.stroke();
      ctx.strokeStyle = 'rgba(212,165,72,0.5)'; ctx.lineWidth = 2;
      [[rW-8,10,rW-8,30],[rW-10,8,rW-30,8],[8,10,8,30],[10,8,30,8],[rW-8,rH-10,rW-8,rH-30],[rW-10,rH-8,rW-30,rH-8],[8,rH-10,8,rH-30],[10,rH-8,30,rH-8]].forEach(([x1,y1,x2,y2]) => { ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); });

      const cx = rW/2;
      let y = rH*0.28;
      ctx.textAlign = 'center';

      // Crescent with glow
      if (!customImageActive) {
        const glowI = 15 + Math.sin(t*Math.PI*2)*12;
        ctx.save();
        const moonX = cx-15, moonY = y-20, moonR = 22;
        ctx.shadowColor = 'rgba(212,165,72,0.7)'; ctx.shadowBlur = glowI;
        ctx.beginPath(); ctx.arc(moonX, moonY, moonR, 0, Math.PI*2);
        const mg = ctx.createRadialGradient(moonX,moonY,0,moonX,moonY,moonR);
        mg.addColorStop(0,'#F0D78C'); mg.addColorStop(1,'#D4A548');
        ctx.fillStyle = mg; ctx.fill();
        ctx.globalCompositeOperation = 'destination-out'; ctx.shadowBlur = 0;
        ctx.beginPath(); ctx.arc(moonX+12, moonY-5, moonR-4, 0, Math.PI*2); ctx.fill();
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = '#F0D78C'; ctx.shadowColor = 'rgba(212,165,72,0.7)'; ctx.shadowBlur = glowI;
        (function drawS(sx,sy,oR,iR,pts){ctx.beginPath();for(let i=0;i<pts*2;i++){const r2=i%2===0?oR:iR;const a=(i*Math.PI/pts)-Math.PI/2;if(i===0)ctx.moveTo(sx+r2*Math.cos(a),sy+r2*Math.sin(a));else ctx.lineTo(sx+r2*Math.cos(a),sy+r2*Math.sin(a));}ctx.closePath();ctx.fill();})(cx+12, y-22, 7, 3, 5);
        ctx.restore();
        y += 30;
      }

      // Greeting
      ctx.font = "bold 32px 'Reem Kufi','Tajawal',sans-serif"; ctx.fillStyle = gC;
      ctx.shadowColor = 'rgba(0,0,0,0.4)'; ctx.shadowBlur = 10;
      ctx.fillText(greeting, cx, y); ctx.shadowBlur = 0; y += 30;

      // Divider
      const dg2 = ctx.createLinearGradient(cx-40,y,cx+40,y);
      dg2.addColorStop(0,'transparent'); dg2.addColorStop(0.5,gC); dg2.addColorStop(1,'transparent');
      ctx.strokeStyle = dg2; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(cx-40,y); ctx.lineTo(cx+40,y); ctx.stroke(); y += 30;

      // Message
      if (message) {
        ctx.font = "18px 'Amiri','Tajawal',serif";
        ctx.fillStyle = isW ? 'rgba(42,31,10,0.85)' : 'rgba(255,248,231,0.85)';
        ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 5;
        const mw = rW*0.75; let line = '';
        for (const w of message.split(' ')) {
          const tl = line+w+' ';
          if(ctx.measureText(tl).width>mw && line) { ctx.fillText(line.trim(),cx,y); line=w+' '; y+=28; } else line=tl;
        }
        ctx.fillText(line.trim(),cx,y); ctx.shadowBlur=0; y+=35;
      }

      if (sender) {
        ctx.font = "bold 20px 'Reem Kufi','Tajawal',sans-serif"; ctx.fillStyle = gC;
        ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 10;
        ctx.fillText(sender, cx, y); ctx.shadowBlur = 0;
      }

      const imgData = ctx.getImageData(0, 0, W, H);
      encoder.addFrame(imgData, frameDelay);

      progressBar.style.width = Math.round(((frame+1)/totalFrames)*80)+'%';
      progressText.textContent = 'â³ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø·Ø§Ø± '+(frame+1)+'/'+totalFrames;
      await new Promise(r => setTimeout(r, 5));
    }

    progressText.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù€ GIF...';
    progressBar.style.width = '85%';
    await new Promise(r => setTimeout(r, 50));

    const gifData = encoder.encode();
    const blob = new Blob([gifData], { type: 'image/gif' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'ramadan-card.gif'; a.click();
    URL.revokeObjectURL(url);

    progressBar.style.width = '100%';
    progressText.textContent = 'âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ GIF!';
    showToast('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ GIF Ø¨Ù†Ø¬Ø§Ø­!');
    setTimeout(() => { progress.style.display = 'none'; }, 3000);
  } catch(e) {
    console.error(e);
    showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ GIF');
    progress.style.display = 'none';
  }
}
</script>
</body>
</html>